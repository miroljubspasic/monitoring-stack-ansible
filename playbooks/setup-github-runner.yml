---
#==============================================================================
# GitHub Actions Self-Hosted Runner Setup
#==============================================================================
# Installs and configures GitHub Actions runner as a systemd service
# Targets: runner_hosts group
#
# Prerequisites:
# - Configure github_org_url in inventory/group_vars/runner_hosts/vars.yml
# - Add vault_github_runner_token to inventory/group_vars/runner_hosts/vault.yml
# - Add runner servers to [runner_hosts] group in inventory/hosts.ini
#
# To get a runner token (valid for 60 minutes):
#   Organization: https://github.com/YOUR_ORG/settings/actions/runners/new
#   Repository: https://github.com/YOUR_ORG/YOUR_REPO/settings/actions/runners/new
#
# Usage:
#   ansible-playbook -i inventory/hosts.ini playbooks/setup-github-runner.yml
#   or: ./deploy.sh setup-runner
#==============================================================================

- name: Setup GitHub Actions Runner
  hosts: runner_hosts
  become: true
  gather_facts: true

  vars:
    runner_user: "{{ runner_stack_user | default('runner') }}"
    runner_group: "{{ runner_stack_group | default(runner_user) }}"
    runner_home: "/home/{{ runner_user }}"
    runner_dir: "{{ runner_home }}/actions-runner"
    runner_version: "2.329.0"
    # ARM64 architecture (default for this setup)
    runner_arch: "arm64"
    runner_download_url: "https://github.com/actions/runner/releases/download/v{{ runner_version }}/actions-runner-linux-{{ runner_arch }}-{{ runner_version }}.tar.gz"
    # ARM64 checksum
    runner_checksum: "56768348b3d643a6a29d4ad71e9bdae0dc0ef1eb01afe0f7a8ee097b039bfaaf"
    # Extract org name from github_org_url (configured in vars.yml)
    # Example: "https://github.com/your-org" -> "your-org"
    github_org_name: "{{ github_org_url | regex_replace('https://github.com/', '') }}"

  tasks:
    #==========================================================================
    # Prerequisites
    #==========================================================================
    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: yes
        cache_valid_time: 3600

    - name: Install required packages
      ansible.builtin.apt:
        name:
          - curl
          - tar
          - jq
          - libssl-dev
          - libicu-dev
          - apt-transport-https
          - ca-certificates
          - gnupg
          - lsb-release
          - acl
        state: present

    #==========================================================================
    # Docker Installation (Modern method for Ubuntu 22.04+)
    #==========================================================================
    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/ubuntu/gpg
        dest: /tmp/docker.gpg
        mode: "0644"

    - name: Convert and install Docker GPG key
      ansible.builtin.shell: |
        gpg --dearmor -o /etc/apt/keyrings/docker.gpg < /tmp/docker.gpg
        chmod a+r /etc/apt/keyrings/docker.gpg
      args:
        creates: /etc/apt/keyrings/docker.gpg

    - name: Get system architecture
      ansible.builtin.command: dpkg --print-architecture
      register: system_arch
      changed_when: false

    - name: Remove legacy Docker repository entry without signed-by
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ system_arch.stdout }}] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: absent
        filename: docker

    - name: Add Docker repository with signed-by
      ansible.builtin.apt_repository:
        repo: "deb [arch={{ system_arch.stdout }} signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu {{ ansible_distribution_release }} stable"
        state: present
        filename: docker

    - name: Install Docker CE
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: yes

    - name: Start and enable Docker service
      ansible.builtin.systemd:
        name: docker
        state: started
        enabled: yes

    - name: Configure Docker socket permissions
      ansible.builtin.file:
        path: /var/run/docker.sock
        owner: root
        group: docker
        mode: "0666"

    #==========================================================================
    # User Setup
    #==========================================================================
    - name: Ensure runner group exists
      ansible.builtin.group:
        name: "{{ runner_group }}"
        state: present

    - name: Ensure runner user exists and has required groups
      ansible.builtin.user:
        name: "{{ runner_user }}"
        group: "{{ runner_group }}"
        groups: "{{ runner_stack_user_groups | default(['sudo', 'docker']) | join(',') if (runner_stack_user_groups | default(['sudo', 'docker'])) | length > 0 else 'docker' }}"
        append: yes
        shell: /bin/bash
        state: present

    - name: Allow runner user to use sudo without password
      ansible.builtin.lineinfile:
        path: /etc/sudoers.d/{{ runner_user }}
        line: "{{ runner_user }} ALL=(ALL) NOPASSWD:ALL"
        create: yes
        mode: "0440"
        validate: "visudo -cf %s"

    - name: Reset connection to apply group membership changes
      ansible.builtin.meta: reset_connection

    #==========================================================================
    # Download and Install Runner
    #==========================================================================
    - name: Check if runner is already installed
      ansible.builtin.stat:
        path: "{{ runner_dir }}/config.sh"
      register: runner_installed

    - name: Check runner architecture compatibility
      ansible.builtin.shell: |
        if [ -f "{{ runner_dir }}/bin/Runner.Listener" ]; then
          file "{{ runner_dir }}/bin/Runner.Listener" | grep -q "{{ 'ARM aarch64' if ansible_architecture == 'aarch64' else 'x86-64' }}"
          echo $?
        else
          echo "2"
        fi
      register: arch_check
      changed_when: false
      failed_when: false

    - name: Remove incompatible runner installation
      ansible.builtin.file:
        path: "{{ runner_dir }}"
        state: absent
      when:
        - runner_installed.stat.exists
        - arch_check.stdout != "0"

    - name: Re-check if runner is installed after cleanup
      ansible.builtin.stat:
        path: "{{ runner_dir }}/config.sh"
      register: runner_installed_after_cleanup

    - name: Create runner directory
      ansible.builtin.file:
        path: "{{ runner_dir }}"
        state: directory
        owner: "{{ runner_user }}"
        group: "{{ runner_group }}"
        mode: "0755"
      when: not runner_installed_after_cleanup.stat.exists

    - name: Download GitHub Actions runner ({{ runner_arch }})
      ansible.builtin.get_url:
        url: "{{ runner_download_url }}"
        dest: "/tmp/actions-runner.tar.gz"
        checksum: "sha256:{{ runner_checksum }}"
        mode: "0644"
      when: not runner_installed_after_cleanup.stat.exists

    - name: Extract runner package
      ansible.builtin.unarchive:
        src: "/tmp/actions-runner.tar.gz"
        dest: "{{ runner_dir }}"
        remote_src: yes
        owner: "{{ runner_user }}"
        group: "{{ runner_group }}"
      when: not runner_installed_after_cleanup.stat.exists

    - name: Clean up downloaded package
      ansible.builtin.file:
        path: "/tmp/actions-runner.tar.gz"
        state: absent
      when: not runner_installed_after_cleanup.stat.exists

    #==========================================================================
    # Configure Runner
    #==========================================================================
    - name: Check if runner is already configured
      ansible.builtin.stat:
        path: "{{ runner_dir }}/.runner"
      register: runner_configured

    - name: Configure GitHub Actions runner
      ansible.builtin.shell: |
        set -e
        ./config.sh \
          --url {{ github_org_url }} \
          --token {{ vault_github_runner_token }} \
          --name {{ ansible_hostname }}-runner \
          --labels self-hosted,Linux,X64,monitoring \
          --work _work \
          --unattended
      args:
        chdir: "{{ runner_dir }}"
        executable: /bin/bash
      become: true
      become_user: "{{ runner_user }}"
      when: not runner_configured.stat.exists
      register: config_result
      failed_when: config_result.rc != 0
      # no_log: true  # Temporarily disabled for debugging

    - name: Display configuration result (on failure)
      ansible.builtin.debug:
        msg: "{{ config_result.stderr_lines | default([]) }}"
      when:
        - not runner_configured.stat.exists
        - config_result.rc != 0

    #==========================================================================
    # Install as systemd Service
    #==========================================================================
    - name: Check if systemd service is already installed
      ansible.builtin.stat:
        path: "/etc/systemd/system/actions.runner.{{ github_org_name }}.{{ ansible_hostname }}-runner.service"
      register: service_installed

    - name: Install runner as systemd service
      ansible.builtin.shell: |
        sudo ./svc.sh install {{ runner_user }}
      args:
        chdir: "{{ runner_dir }}"
      when: not service_installed.stat.exists
      register: svc_install_result
      failed_when: svc_install_result.rc != 0

    - name: Display service installation result (on failure)
      ansible.builtin.debug:
        msg: "{{ svc_install_result.stderr_lines | default([]) }}"
      when:
        - not service_installed.stat.exists
        - svc_install_result.rc != 0

    - name: Start and enable GitHub Actions runner service
      ansible.builtin.systemd:
        name: actions.runner.{{ github_org_name }}.{{ ansible_hostname }}-runner.service
        state: started
        enabled: yes
        daemon_reload: yes

    #==========================================================================
    # Verification
    #==========================================================================
    - name: Check runner service status
      ansible.builtin.systemd:
        name: actions.runner.{{ github_org_name }}.{{ ansible_hostname }}-runner.service
      register: runner_service

    - name: Display runner setup summary
      ansible.builtin.debug:
        msg: |
          ============================================================
          GitHub Actions Runner Setup Complete
          ============================================================
          Runner User: {{ runner_user }}
          Runner Directory: {{ runner_dir }}
          Organization: {{ github_org_url }}
          Runner Name: {{ ansible_hostname }}-runner
          Labels: self-hosted,Linux,X64,monitoring

          Service Name: actions.runner.{{ github_org_name }}.{{ ansible_hostname }}-runner.service
          Service Status: {{ runner_service.status.ActiveState }}

          To check logs:
            sudo journalctl -u actions.runner.{{ github_org_name }}.{{ ansible_hostname }}-runner.service -f

          To manage service:
            sudo systemctl status actions.runner.{{ github_org_name }}.{{ ansible_hostname }}-runner.service
            sudo systemctl restart actions.runner.{{ github_org_name }}.{{ ansible_hostname }}-runner.service
          ============================================================
